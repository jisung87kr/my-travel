---
name: 상품 관리 시스템
status: done
created: 2025-12-03T13:45:12Z
updated: 2025-12-04T00:20:00Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 003]
parallel: true
conflicts_with: []
---

# Task: 상품 관리 시스템

## Description

관광 상품의 CRUD 기능을 구현합니다. 다국어 지원(한/영/중/일), 이미지 업로드, 가격 옵션 관리, 검색 및 필터링 기능을 포함합니다.

## Acceptance Criteria

- [x] 상품 생성 (3가지 유형: 당일/숙박/체험)
- [x] 상품 조회 (목록/상세)
- [x] 상품 수정
- [x] 상품 삭제 (soft delete)
- [x] 다국어 상품 정보 입력/조회
- [x] 이미지 다중 업로드 및 순서 관리
- [x] 가격 옵션 관리 (성인/아동/추가옵션)
- [x] 지역별, 유형별, 날짜별 필터링
- [x] 키워드 검색

## Technical Details

### 컨트롤러 구조

```
app/Http/Controllers/
├── ProductController.php           # 공개 상품 조회 (관광객용)
└── Vendor/
    └── ProductController.php       # 제공자 상품 관리
```

### 서비스 레이어

```php
// app/Services/ProductService.php
class ProductService
{
    public function create(array $data, User $vendor): Product;
    public function update(Product $product, array $data): Product;
    public function delete(Product $product): bool;
    public function uploadImages(Product $product, array $files): void;
    public function reorderImages(Product $product, array $order): void;
    public function search(array $filters): LengthAwarePaginator;
}
```

### API 엔드포인트

```php
// 공개 API (관광객용)
Route::get('/products', [ProductController::class, 'index']);
Route::get('/products/{product}', [ProductController::class, 'show']);

// 제공자 API
Route::middleware(['auth', 'role:vendor'])->prefix('vendor')->group(function () {
    Route::get('/products', [Vendor\ProductController::class, 'index']);
    Route::post('/products', [Vendor\ProductController::class, 'store']);
    Route::get('/products/{product}', [Vendor\ProductController::class, 'show']);
    Route::put('/products/{product}', [Vendor\ProductController::class, 'update']);
    Route::delete('/products/{product}', [Vendor\ProductController::class, 'destroy']);
    Route::post('/products/{product}/images', [Vendor\ProductController::class, 'uploadImages']);
    Route::put('/products/{product}/images/reorder', [Vendor\ProductController::class, 'reorderImages']);
    Route::delete('/products/{product}/images/{image}', [Vendor\ProductController::class, 'deleteImage']);
});
```

### 다국어 처리

```php
// app/Models/Product.php
public function translations(): HasMany
{
    return $this->hasMany(ProductTranslation::class);
}

public function getTranslation(string $locale = null): ?ProductTranslation
{
    $locale = $locale ?? app()->getLocale();
    return $this->translations->firstWhere('locale', $locale)
        ?? $this->translations->firstWhere('locale', 'ko');
}

// 사용 예시
$product->getTranslation('en')->name;
$product->getTranslation('en')->description;
```

### 필터링 쿼리

```php
// app/Http/Controllers/ProductController.php
public function index(Request $request)
{
    $query = Product::query()
        ->with(['translations', 'prices', 'images', 'vendor'])
        ->where('status', 'active');

    // 지역 필터
    if ($request->region) {
        $query->where('region', $request->region);
    }

    // 유형 필터
    if ($request->type) {
        $query->where('type', $request->type);
    }

    // 날짜 필터 (해당 날짜에 재고 있는 상품)
    if ($request->date) {
        $query->whereHas('schedules', function ($q) use ($request) {
            $q->where('date', $request->date)
              ->where('available_count', '>', 0)
              ->where('is_active', true);
        });
    }

    // 키워드 검색 (다국어)
    if ($request->keyword) {
        $query->whereHas('translations', function ($q) use ($request) {
            $q->where('name', 'like', "%{$request->keyword}%")
              ->orWhere('description', 'like', "%{$request->keyword}%");
        });
    }

    return $query->paginate(20);
}
```

### Form Request Validation

```php
// app/Http/Requests/StoreProductRequest.php
public function rules(): array
{
    return [
        'type' => 'required|in:day_tour,package,activity',
        'region' => 'required|string|max:100',
        'duration' => 'required|integer|min:1',
        'min_persons' => 'required|integer|min:1',
        'max_persons' => 'required|integer|gte:min_persons',
        'booking_type' => 'required|in:instant,request',

        // 다국어 필드
        'translations' => 'required|array|min:1',
        'translations.*.locale' => 'required|in:ko,en,zh,ja',
        'translations.*.name' => 'required|string|max:200',
        'translations.*.description' => 'required|string',
        'translations.*.includes' => 'nullable|string',
        'translations.*.excludes' => 'nullable|string',
        'translations.*.notes' => 'nullable|string',

        // 가격
        'prices' => 'required|array|min:1',
        'prices.*.type' => 'required|in:adult,child,option',
        'prices.*.label' => 'nullable|string|max:100',
        'prices.*.amount' => 'required|numeric|min:0',

        // 이미지
        'images' => 'nullable|array',
        'images.*' => 'image|max:5120', // 5MB
    ];
}
```

## Dependencies

- [ ] Task 002 완료 (Product 모델 및 관련 테이블)
- [ ] Task 003 완료 (인증, 역할 기반 접근 제어)
- [ ] intervention/image 패키지 설치됨

## Effort Estimate

- Size: L
- Complexity: High
- Parallel: true (Task 005와 병렬 가능, 단 모델 충돌 주의)

## Definition of Done

- [x] 제공자가 상품 CRUD 모두 가능
- [x] 4개 언어 다국어 입력/조회 정상 동작
- [x] 이미지 업로드 및 리사이징 동작
- [x] 필터링 및 검색 정상 동작
- [x] API 응답 포맷 일관성 확인
- [x] Feature Test 작성 (ProductTest.php)

## Completion Notes

- **완료일**: 2025-12-04
- **테스트 결과**: 179개 테스트 통과 (전체, 상품 관련 54개)
- **주요 구현 파일**:
  - `app/Services/ProductService.php` - 상품 비즈니스 로직
  - `app/Http/Controllers/ProductController.php` - 공개 상품 API
  - `app/Http/Controllers/Vendor/ProductController.php` - 벤더 상품 CRUD API
  - `app/Http/Requests/Vendor/StoreProductRequest.php` - 생성 유효성 검사
  - `app/Http/Requests/Vendor/UpdateProductRequest.php` - 수정 유효성 검사
  - `app/Policies/ProductPolicy.php` - 상품 접근 권한 관리
  - `database/factories/ProductPriceFactory.php` - 가격 테스트 팩토리
  - `database/factories/ProductImageFactory.php` - 이미지 테스트 팩토리
  - `tests/Unit/Services/ProductServiceTest.php` - 서비스 유닛 테스트
  - `tests/Unit/Policies/ProductPolicyTest.php` - 정책 유닛 테스트
  - `tests/Feature/Products/PublicProductTest.php` - 공개 API 테스트
  - `tests/Feature/Products/VendorProductTest.php` - 벤더 API 테스트
- **추가 마이그레이션**: `2025_12_04_100001_add_additional_fields_to_products_table.php`
- **Enum 업데이트**: `Region.php`에 BUSAN 추가