---
name: 리뷰 & 커뮤니케이션
status: done
created: 2025-12-03T13:45:12Z
updated: 2025-12-04T13:25:00Z
github: [Will be updated when synced to GitHub]
depends_on: [005, 006, 007]
parallel: false
conflicts_with: []
---

# Task: 리뷰 & 커뮤니케이션

## Description

리뷰 시스템과 메시지 시스템을 구현합니다. 이메일 알림 기능을 추가하여 예약 상태 변경 시 사용자에게 알림을 발송합니다.

## Acceptance Criteria

### 리뷰 시스템
- [ ] 완료된 예약에 대해 리뷰 작성
- [ ] 별점 (1~5) + 텍스트 리뷰
- [ ] 리뷰 이미지 첨부 (최대 5장)
- [ ] 리뷰 수정/삭제
- [ ] 제공자 답변 작성
- [ ] 부적절한 리뷰 신고
- [ ] 상품 상세 페이지에 리뷰 목록 표시
- [ ] 평균 평점 계산 및 표시

### 메시지 시스템
- [ ] 예약별 메시지 스레드
- [ ] 관광객 ↔ 제공자 메시지 송수신
- [ ] 읽음 표시
- [ ] 새 메시지 알림

### 이메일 알림
- [ ] 예약 생성 시 알림 (관광객, 제공자)
- [ ] 예약 승인 시 알림 (관광객)
- [ ] 예약 거절 시 알림 (관광객)
- [ ] 예약 취소 시 알림 (관광객, 제공자)
- [ ] 새 메시지 알림

## Technical Details

### 리뷰 컨트롤러

```php
// app/Http/Controllers/ReviewController.php
class ReviewController extends Controller
{
    public function store(StoreReviewRequest $request, Booking $booking)
    {
        // 리뷰 작성 가능 여부 확인
        if ($booking->status !== BookingStatus::COMPLETED) {
            return back()->with('error', '완료된 예약만 리뷰를 작성할 수 있습니다.');
        }

        if ($booking->review) {
            return back()->with('error', '이미 리뷰를 작성했습니다.');
        }

        $review = $booking->review()->create([
            'user_id' => auth()->id(),
            'rating' => $request->rating,
            'content' => $request->content,
        ]);

        // 이미지 저장
        if ($request->hasFile('images')) {
            foreach ($request->file('images') as $image) {
                $path = $image->store('reviews', 'public');
                $review->images()->create(['path' => $path]);
            }
        }

        // 상품 평균 평점 업데이트
        $this->updateProductRating($booking->product);

        return redirect()->route('my.bookings')->with('success', '리뷰가 등록되었습니다.');
    }

    public function reply(Request $request, Review $review)
    {
        $this->authorize('reply', $review);

        $review->update([
            'vendor_reply' => $request->reply,
            'replied_at' => now(),
        ]);

        return back()->with('success', '답변이 등록되었습니다.');
    }

    public function report(Request $request, Review $review)
    {
        Report::create([
            'reporter_id' => auth()->id(),
            'reportable_type' => Review::class,
            'reportable_id' => $review->id,
            'reason' => $request->reason,
        ]);

        return back()->with('success', '신고가 접수되었습니다.');
    }
}
```

### 메시지 서비스

```php
// app/Services/MessageService.php
class MessageService
{
    public function __construct(
        private NotificationService $notificationService
    ) {}

    public function send(Booking $booking, User $sender, string $content): Message
    {
        $receiver = $this->getReceiver($booking, $sender);

        $message = Message::create([
            'booking_id' => $booking->id,
            'sender_id' => $sender->id,
            'receiver_id' => $receiver->id,
            'content' => $content,
        ]);

        // 알림 발송
        $this->notificationService->newMessage($message);

        return $message;
    }

    public function markAsRead(Message $message, User $user): void
    {
        if ($message->receiver_id === $user->id && !$message->read_at) {
            $message->update(['read_at' => now()]);
        }
    }

    public function getThread(Booking $booking): Collection
    {
        return Message::where('booking_id', $booking->id)
            ->orderBy('created_at')
            ->get();
    }

    private function getReceiver(Booking $booking, User $sender): User
    {
        // 발신자가 관광객이면 제공자에게, 제공자면 관광객에게
        return $sender->id === $booking->user_id
            ? $booking->product->vendor->user
            : $booking->user;
    }
}
```

### 알림 클래스

```php
// app/Notifications/BookingCreatedNotification.php
class BookingCreatedNotification extends Notification implements ShouldQueue
{
    use Queueable;

    public function __construct(
        public Booking $booking
    ) {}

    public function via($notifiable): array
    {
        return ['mail', 'database'];
    }

    public function toMail($notifiable): MailMessage
    {
        return (new MailMessage)
            ->subject(__('notifications.booking_created.subject'))
            ->greeting(__('notifications.booking_created.greeting', ['name' => $notifiable->name]))
            ->line(__('notifications.booking_created.line1', [
                'product' => $this->booking->product->getTranslation()->name,
                'date' => $this->booking->schedule->date->format('Y-m-d'),
            ]))
            ->action(__('notifications.booking_created.action'), route('my.bookings'))
            ->line(__('notifications.booking_created.thanks'));
    }

    public function toArray($notifiable): array
    {
        return [
            'booking_id' => $this->booking->id,
            'type' => 'booking_created',
        ];
    }
}

// 다른 알림 클래스들
// - BookingApprovedNotification
// - BookingRejectedNotification
// - BookingCancelledNotification
// - NewMessageNotification
```

### 알림 서비스

```php
// app/Services/NotificationService.php
class NotificationService
{
    public function bookingCreated(Booking $booking): void
    {
        // 관광객에게 알림
        $booking->user->notify(new BookingCreatedNotification($booking));

        // 제공자에게 알림 (승인 필요 예약인 경우)
        if ($booking->status === BookingStatus::PENDING) {
            $booking->product->vendor->user->notify(
                new NewBookingRequestNotification($booking)
            );
        }
    }

    public function bookingApproved(Booking $booking): void
    {
        $booking->user->notify(new BookingApprovedNotification($booking));
    }

    public function bookingRejected(Booking $booking): void
    {
        $booking->user->notify(new BookingRejectedNotification($booking));
    }

    public function bookingCancelled(Booking $booking): void
    {
        // 취소자가 아닌 상대방에게 알림
        $booking->user->notify(new BookingCancelledNotification($booking));
        $booking->product->vendor->user->notify(new BookingCancelledNotification($booking));
    }

    public function newMessage(Message $message): void
    {
        $message->receiver->notify(new NewMessageNotification($message));
    }
}
```

### Vue 컴포넌트

```
resources/js/components/
├── review/
│   ├── ReviewForm.vue           # 리뷰 작성 폼
│   ├── ReviewList.vue           # 리뷰 목록
│   ├── ReviewItem.vue           # 개별 리뷰
│   ├── StarRating.vue           # 별점 입력/표시
│   └── ImageUploader.vue        # 리뷰 이미지 업로드
└── message/
    ├── MessageThread.vue        # 메시지 스레드
    ├── MessageInput.vue         # 메시지 입력
    └── MessageBubble.vue        # 메시지 말풍선
```

### 이메일 템플릿

```
resources/views/emails/
├── booking-created.blade.php
├── booking-approved.blade.php
├── booking-rejected.blade.php
├── booking-cancelled.blade.php
└── new-message.blade.php
```

### 라우트

```php
// 리뷰
Route::middleware('auth')->group(function () {
    Route::post('/bookings/{booking}/review', [ReviewController::class, 'store']);
    Route::put('/reviews/{review}', [ReviewController::class, 'update']);
    Route::delete('/reviews/{review}', [ReviewController::class, 'destroy']);
    Route::post('/reviews/{review}/report', [ReviewController::class, 'report']);
});

Route::middleware(['auth', 'role:vendor'])->prefix('vendor')->group(function () {
    Route::post('/reviews/{review}/reply', [ReviewController::class, 'reply']);
});

// 메시지
Route::middleware('auth')->group(function () {
    Route::get('/bookings/{booking}/messages', [MessageController::class, 'index']);
    Route::post('/bookings/{booking}/messages', [MessageController::class, 'store']);
    Route::patch('/messages/{message}/read', [MessageController::class, 'markAsRead']);
});
```

## Dependencies

- [ ] Task 005 완료 (예약 완료 상태)
- [ ] Task 006 완료 (관광객 UI - 리뷰 작성)
- [ ] Task 007 완료 (제공자 UI - 리뷰 답변, 메시지)
- [ ] SendGrid API 키 설정
- [ ] Queue 설정 (이메일 발송용)

## Effort Estimate

- Size: M
- Complexity: Low-Medium
- Parallel: false (UI 태스크 이후)

## Definition of Done

- [ ] 완료된 예약에 리뷰 작성 가능
- [ ] 별점 + 텍스트 + 이미지 리뷰 등록 동작
- [ ] 상품 상세 페이지에 리뷰 목록 표시
- [ ] 제공자 답변 동작
- [ ] 메시지 송수신 동작
- [ ] 읽음 표시 동작
- [ ] 이메일 알림 발송 확인 (Mailtrap 등)
- [ ] Feature Test 작성 (ReviewTest.php, MessageTest.php)