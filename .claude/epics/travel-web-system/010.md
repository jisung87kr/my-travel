---
name: 테스트 & 배포 준비
status: open
created: 2025-12-03T13:45:12Z
updated: 2025-12-03T13:45:12Z
github: [Will be updated when synced to GitHub]
depends_on: [006, 007, 008, 009]
parallel: false
conflicts_with: []
---

# Task: 테스트 & 배포 준비

## Description

전체 시스템에 대한 테스트를 작성하고, 프로덕션 배포를 위한 준비를 완료합니다. 성능 최적화, 보안 점검, 배포 스크립트 작성을 포함합니다.

## Acceptance Criteria

### 테스트
- [ ] Feature Test: 주요 사용자 플로우 커버
- [ ] Unit Test: 핵심 비즈니스 로직 커버
- [ ] 테스트 커버리지 60% 이상
- [ ] 모든 테스트 통과

### 성능 최적화
- [ ] N+1 쿼리 제거 (Eager Loading)
- [ ] 데이터베이스 인덱스 최적화
- [ ] 이미지 최적화 (리사이징, lazy loading)
- [ ] 프론트엔드 번들 최적화

### 보안
- [ ] CSRF 토큰 적용 확인
- [ ] XSS 방지 확인
- [ ] SQL Injection 방지 확인
- [ ] 인증/권한 검사 누락 점검
- [ ] 환경변수 노출 점검

### 배포
- [ ] 프로덕션 환경 설정
- [ ] 배포 스크립트 작성
- [ ] 백업 스크립트 작성
- [ ] 모니터링 설정 (에러 로깅)

## Technical Details

### Feature Test 목록

```php
// tests/Feature/AuthTest.php
- test_user_can_register()
- test_user_can_login()
- test_user_can_logout()
- test_social_login_redirect()
- test_role_based_access_control()

// tests/Feature/ProductTest.php
- test_guest_can_view_products()
- test_guest_can_view_product_detail()
- test_vendor_can_create_product()
- test_vendor_can_update_product()
- test_vendor_can_delete_product()
- test_product_search_and_filter()
- test_product_multilingual_content()

// tests/Feature/BookingTest.php
- test_traveler_can_create_instant_booking()
- test_traveler_can_create_request_booking()
- test_vendor_can_approve_booking()
- test_vendor_can_reject_booking()
- test_traveler_can_cancel_booking()
- test_inventory_decreases_on_booking()
- test_inventory_restores_on_cancellation()
- test_no_show_count_increases()
- test_blocked_user_cannot_book()

// tests/Feature/ReviewTest.php
- test_traveler_can_write_review()
- test_vendor_can_reply_review()
- test_user_can_report_review()

// tests/Feature/MessageTest.php
- test_traveler_can_send_message()
- test_vendor_can_reply_message()
```

### Unit Test 목록

```php
// tests/Unit/BookingServiceTest.php
- test_calculate_total_price()
- test_determine_initial_status()
- test_booking_status_transitions()

// tests/Unit/InventoryServiceTest.php
- test_check_availability()
- test_decrease_stock()
- test_increase_stock()
- test_concurrent_booking_handling()

// tests/Unit/ProductTest.php
- test_get_translation()
- test_average_rating_calculation()
```

### 데이터베이스 인덱스

```php
// database/migrations/add_indexes.php
Schema::table('products', function (Blueprint $table) {
    $table->index(['status', 'region']);
    $table->index('type');
    $table->index('vendor_id');
});

Schema::table('product_schedules', function (Blueprint $table) {
    $table->index(['product_id', 'date']);
    $table->index(['date', 'is_active', 'available_count']);
});

Schema::table('bookings', function (Blueprint $table) {
    $table->index(['user_id', 'status']);
    $table->index(['product_id', 'status']);
    $table->index('schedule_id');
});

Schema::table('product_translations', function (Blueprint $table) {
    $table->fullText(['name', 'description']);
});
```

### N+1 쿼리 수정

```php
// 수정 전
$products = Product::all();
foreach ($products as $product) {
    echo $product->vendor->name;  // N+1!
    echo $product->translations;  // N+1!
}

// 수정 후
$products = Product::with(['vendor', 'translations', 'prices', 'images'])
    ->get();
```

### 프론트엔드 최적화

```js
// vite.config.js
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['vue', 'pinia', 'axios'],
          fullcalendar: ['@fullcalendar/core', '@fullcalendar/daygrid'],
        },
      },
    },
  },
});
```

### 이미지 최적화

```php
// app/Services/ImageService.php
class ImageService
{
    public function store(UploadedFile $file, string $directory): string
    {
        $image = Image::make($file);

        // 리사이징 (최대 1200px)
        $image->resize(1200, null, function ($constraint) {
            $constraint->aspectRatio();
            $constraint->upsize();
        });

        // 품질 조정
        $image->encode('jpg', 80);

        $path = $directory . '/' . Str::uuid() . '.jpg';
        Storage::put($path, $image->stream());

        return $path;
    }

    public function generateThumbnail(string $path): string
    {
        $image = Image::make(Storage::get($path));
        $image->fit(300, 200);

        $thumbPath = str_replace('.jpg', '_thumb.jpg', $path);
        Storage::put($thumbPath, $image->stream());

        return $thumbPath;
    }
}
```

### 보안 체크리스트

```php
// 1. CSRF - 모든 POST/PUT/DELETE 폼에 @csrf
// 2. XSS - Blade에서 {{ }} 사용 (escape됨)
// 3. SQL Injection - Eloquent ORM 사용, raw query 피하기
// 4. Mass Assignment - $fillable 또는 $guarded 설정
// 5. Authorization - Policy 사용

// app/Policies/BookingPolicy.php
public function cancel(User $user, Booking $booking): bool
{
    return $user->id === $booking->user_id
        || $user->id === $booking->product->vendor->user_id;
}

// Controller에서 사용
$this->authorize('cancel', $booking);
```

### 배포 스크립트

```bash
#!/bin/bash
# deploy.sh

set -e

echo "Deploying application..."

# 유지보수 모드 활성화
php artisan down

# 코드 업데이트
git pull origin main

# Composer 의존성
composer install --no-dev --optimize-autoloader

# NPM 빌드
npm ci
npm run build

# 캐시 클리어 및 재생성
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan event:cache

# 마이그레이션
php artisan migrate --force

# Queue 재시작
php artisan queue:restart

# 유지보수 모드 해제
php artisan up

echo "Deployment complete!"
```

### 백업 스크립트

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# 데이터베이스 백업
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# 파일 백업 (업로드된 이미지 등)
tar -czf $BACKUP_DIR/storage_$DATE.tar.gz storage/app/public

# 7일 이전 백업 삭제
find $BACKUP_DIR -type f -mtime +7 -delete

echo "Backup complete: $DATE"
```

### 에러 로깅 설정

```php
// config/logging.php
'channels' => [
    'stack' => [
        'driver' => 'stack',
        'channels' => ['daily', 'slack'],
    ],

    'slack' => [
        'driver' => 'slack',
        'url' => env('LOG_SLACK_WEBHOOK_URL'),
        'username' => 'Laravel Log',
        'emoji' => ':boom:',
        'level' => 'error',
    ],
],
```

### 환경변수 체크

```php
// app/Console/Commands/CheckEnv.php
class CheckEnv extends Command
{
    protected $signature = 'app:check-env';

    public function handle()
    {
        $required = [
            'APP_KEY', 'DB_DATABASE', 'DB_USERNAME', 'DB_PASSWORD',
            'MAIL_HOST', 'MAIL_USERNAME', 'MAIL_PASSWORD',
            'GOOGLE_CLIENT_ID', 'GOOGLE_CLIENT_SECRET',
            'KAKAO_CLIENT_ID', 'KAKAO_CLIENT_SECRET',
            'APPLE_CLIENT_ID', 'APPLE_CLIENT_SECRET',
        ];

        $missing = [];
        foreach ($required as $key) {
            if (empty(env($key))) {
                $missing[] = $key;
            }
        }

        if (count($missing) > 0) {
            $this->error('Missing environment variables:');
            foreach ($missing as $key) {
                $this->line("  - $key");
            }
            return 1;
        }

        $this->info('All required environment variables are set!');
        return 0;
    }
}
```

## Dependencies

- [ ] Task 006, 007, 008, 009 완료 (전체 기능 구현)
- [ ] 테스트 환경 (SQLite 또는 테스트 DB)
- [ ] Slack Webhook (에러 로깅용, 선택)

## Effort Estimate

- Size: M
- Complexity: Medium
- Parallel: false (최종 태스크)

## Definition of Done

- [ ] 모든 Feature Test 통과
- [ ] 모든 Unit Test 통과
- [ ] 테스트 커버리지 60% 이상
- [ ] Laravel Pint 코드 스타일 통과
- [ ] Lighthouse 성능 점수 70+ (모바일)
- [ ] 배포 스크립트 실행 성공
- [ ] 백업 스크립트 실행 성공
- [ ] 에러 로깅 동작 확인
- [ ] 최종 QA 체크리스트 통과