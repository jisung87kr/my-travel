---
name: 예약 시스템 구현
status: done
created: 2025-12-03T13:45:12Z
updated: 2025-12-04T00:00:00Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 003, 004]
parallel: false
conflicts_with: []
---

# Task: 예약 시스템 구현

## Description

관광 상품 예약 시스템의 핵심 비즈니스 로직을 구현합니다. 자동 확정/승인 필요 예약 방식, 실시간 재고 관리, 예약 상태 관리, 취소/변경 기능을 포함합니다.

## Acceptance Criteria

- [x] 예약 생성 (날짜, 인원, 옵션 선택)
- [x] 자동 확정(Instant) 예약 처리
- [x] 승인 필요(Request) 예약 처리
- [x] 예약 승인/거절 (제공자)
- [x] 예약 취소 (관광객/제공자)
- [x] 실시간 재고 차감/복구
- [x] 예약 상태 변경 (pending → confirmed → completed)
- [x] 예약 목록 조회 (관광객/제공자별)
- [x] 노쇼 처리 및 카운트 증가

## Technical Details

### 서비스 레이어

```php
// app/Services/BookingService.php
class BookingService
{
    public function __construct(
        private InventoryService $inventoryService,
        private NotificationService $notificationService
    ) {}

    public function create(array $data, User $user): Booking
    {
        return DB::transaction(function () use ($data, $user) {
            // 1. 재고 확인
            $schedule = $this->inventoryService->checkAvailability(
                $data['product_id'],
                $data['date'],
                $data['adult_count'] + $data['child_count']
            );

            if (!$schedule) {
                throw new InsufficientInventoryException();
            }

            // 2. 예약 생성
            $booking = Booking::create([
                'product_id' => $data['product_id'],
                'user_id' => $user->id,
                'schedule_id' => $schedule->id,
                'adult_count' => $data['adult_count'],
                'child_count' => $data['child_count'],
                'total_price' => $this->calculatePrice($data),
                'status' => $this->determineInitialStatus($data['product_id']),
            ]);

            // 3. 옵션 저장
            foreach ($data['options'] ?? [] as $option) {
                $booking->options()->create($option);
            }

            // 4. 재고 차감
            $this->inventoryService->decreaseStock($schedule, $booking->totalPersons());

            // 5. 알림 발송
            $this->notificationService->bookingCreated($booking);

            return $booking;
        });
    }

    public function approve(Booking $booking): Booking
    {
        if ($booking->status !== BookingStatus::PENDING) {
            throw new InvalidBookingStatusException();
        }

        $booking->update(['status' => BookingStatus::CONFIRMED]);
        $this->notificationService->bookingApproved($booking);

        return $booking;
    }

    public function reject(Booking $booking, string $reason = null): Booking
    {
        if ($booking->status !== BookingStatus::PENDING) {
            throw new InvalidBookingStatusException();
        }

        return DB::transaction(function () use ($booking, $reason) {
            $booking->update([
                'status' => BookingStatus::CANCELLED,
                'cancel_reason' => $reason,
            ]);

            // 재고 복구
            $this->inventoryService->increaseStock(
                $booking->schedule,
                $booking->totalPersons()
            );

            $this->notificationService->bookingRejected($booking);

            return $booking;
        });
    }

    public function cancel(Booking $booking, User $user): Booking
    {
        // 취소 가능 상태 확인
        if (!in_array($booking->status, [BookingStatus::PENDING, BookingStatus::CONFIRMED])) {
            throw new InvalidBookingStatusException();
        }

        return DB::transaction(function () use ($booking) {
            $booking->update(['status' => BookingStatus::CANCELLED]);

            // 재고 복구
            $this->inventoryService->increaseStock(
                $booking->schedule,
                $booking->totalPersons()
            );

            $this->notificationService->bookingCancelled($booking);

            return $booking;
        });
    }

    public function complete(Booking $booking): Booking
    {
        $booking->update([
            'status' => BookingStatus::COMPLETED,
            'completed_at' => now(),
        ]);

        return $booking;
    }

    public function markNoShow(Booking $booking): Booking
    {
        return DB::transaction(function () use ($booking) {
            $booking->update(['status' => BookingStatus::NO_SHOW]);

            // 사용자 노쇼 카운트 증가
            $booking->user->increment('no_show_count');

            // 일정 횟수 이상이면 예약 제한
            if ($booking->user->no_show_count >= 3) {
                $booking->user->update(['is_blocked' => true]);
            }

            return $booking;
        });
    }

    private function determineInitialStatus(int $productId): BookingStatus
    {
        $product = Product::find($productId);

        return $product->booking_type === BookingType::INSTANT
            ? BookingStatus::CONFIRMED
            : BookingStatus::PENDING;
    }
}
```

### 재고 관리 서비스

```php
// app/Services/InventoryService.php
class InventoryService
{
    public function checkAvailability(int $productId, string $date, int $persons): ?ProductSchedule
    {
        return ProductSchedule::where('product_id', $productId)
            ->where('date', $date)
            ->where('is_active', true)
            ->where('available_count', '>=', $persons)
            ->lockForUpdate()
            ->first();
    }

    public function decreaseStock(ProductSchedule $schedule, int $count): void
    {
        $schedule->decrement('available_count', $count);
    }

    public function increaseStock(ProductSchedule $schedule, int $count): void
    {
        $schedule->increment('available_count', $count);
    }

    public function setDailyCapacity(int $productId, string $date, int $count): ProductSchedule
    {
        return ProductSchedule::updateOrCreate(
            ['product_id' => $productId, 'date' => $date],
            ['available_count' => $count, 'is_active' => true]
        );
    }

    public function closeDate(int $productId, string $date): void
    {
        ProductSchedule::where('product_id', $productId)
            ->where('date', $date)
            ->update(['is_active' => false]);
    }
}
```

### API 엔드포인트

```php
// 관광객
Route::middleware(['auth', 'role:traveler'])->group(function () {
    Route::post('/bookings', [BookingController::class, 'store']);
    Route::get('/my/bookings', [BookingController::class, 'myBookings']);
    Route::get('/bookings/{booking}', [BookingController::class, 'show']);
    Route::delete('/bookings/{booking}', [BookingController::class, 'cancel']);
});

// 제공자
Route::middleware(['auth', 'role:vendor'])->prefix('vendor')->group(function () {
    Route::get('/bookings', [Vendor\BookingController::class, 'index']);
    Route::get('/bookings/{booking}', [Vendor\BookingController::class, 'show']);
    Route::patch('/bookings/{booking}/approve', [Vendor\BookingController::class, 'approve']);
    Route::patch('/bookings/{booking}/reject', [Vendor\BookingController::class, 'reject']);
    Route::patch('/bookings/{booking}/complete', [Vendor\BookingController::class, 'complete']);
    Route::patch('/bookings/{booking}/no-show', [Vendor\BookingController::class, 'markNoShow']);

    // 일정/재고 관리
    Route::get('/products/{product}/schedules', [Vendor\ScheduleController::class, 'index']);
    Route::put('/products/{product}/schedules', [Vendor\ScheduleController::class, 'update']);
});
```

### 예외 클래스

```php
// app/Exceptions/
├── InsufficientInventoryException.php
├── InvalidBookingStatusException.php
├── BookingNotAllowedException.php  // 노쇼로 인한 예약 제한
└── BookingExpiredException.php     // 지난 날짜 예약 시도
```

## Dependencies

- [x] Task 002 완료 (Booking, ProductSchedule 모델)
- [x] Task 003 완료 (인증)
- [x] Task 004 완료 (Product 조회)

## Effort Estimate

- Size: L
- Complexity: High (동시성 처리, 상태 관리)
- Parallel: false (핵심 비즈니스 로직)

## Definition of Done

- [x] 자동 확정 예약 생성 및 재고 차감 동작
- [x] 승인 필요 예약 → 승인 → 확정 플로우 동작
- [x] 예약 취소 시 재고 복구 확인
- [x] 노쇼 처리 및 예약 제한 동작
- [x] 동시 예약 시 재고 정합성 테스트
- [x] Feature Test 작성 (BookingTest.php)
- [x] Unit Test 작성 (BookingServiceTest.php, InventoryServiceTest.php)

## Completion Notes

**Completed: 2025-12-04**

### Test Results
- 57 tests passed (Booking related)
- 236 total tests passing

### Key Files Created
- `app/Services/BookingService.php` - Core booking business logic
- `app/Services/InventoryService.php` - Stock/schedule management
- `app/Http/Controllers/BookingController.php` - Traveler booking API
- `app/Http/Controllers/Vendor/BookingController.php` - Vendor booking management
- `app/Http/Controllers/Vendor/ScheduleController.php` - Schedule/inventory management
- `app/Policies/BookingPolicy.php` - Authorization
- `app/Exceptions/InsufficientInventoryException.php`
- `app/Exceptions/InvalidBookingStatusException.php`
- `app/Exceptions/BookingNotAllowedException.php`
- `app/Exceptions/BookingExpiredException.php`

### Test Files
- `tests/Unit/Services/BookingServiceTest.php` - 15 tests
- `tests/Unit/Services/InventoryServiceTest.php` - 11 tests
- `tests/Feature/Bookings/TravelerBookingTest.php` - 12 tests
- `tests/Feature/Bookings/VendorBookingTest.php` - 11 tests
- `tests/Feature/Bookings/ScheduleTest.php` - 8 tests